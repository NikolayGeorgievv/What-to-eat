<!DOCTYPE html>
<html xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/1a33788db9.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{'/css/mainStyling.css'}">
    <meta charset="UTF-8">
    <title>Result page</title>
</head>
<body>
<div th:replace="~{fragments/nav-bar}"></div>


<div th:replace="~{fragments/search-bar}"></div>

<div class="container my-1 d-flex flex-column align-items-center" id="recipeContainer">
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item"><a th:if="${page.hasPrevious()}"
                                     th:href="@{/search(page=${page.number - 1}, size=${page.size}, searchType=${searchType}, productName=${productName}, recipeName=${recipeName})}">Предишна</a>
            </li>
            <li class="page-item"><span th:text="'(' +  ${page.number + 1} + ')'">1</span></li>
            <li class="page-item"><a th:if="${page.hasNext()}"
                                     th:href="@{/search(page=${page.number + 1}, size=${page.size}, searchType=${searchType}, productName=${productName}, recipeName=${recipeName})}">Следваща</a>
            </li>
        </ul>
    </nav>
    <div id="results" class="row row-cols-1 row-cols-sm-3 row-cols-md-3 g-3" >
        <div th:each="recipe : ${page.content}" id="singleRecipe" class="col-6 col-sm-4 col-md-3" th:attr="data-recipe-id=${recipe.id}">
            <div class="d-flex justify-content-around">
                <h3 th:text="${recipe.name}">Recipe Name</h3>
                <div sec:authorize="isAuthenticated()">
                    <div th:if="${favoritesMap[recipe.id] != true}">
                        <form id="addToFavoriteForm"  th:action="@{/addToFavorite}" method="post">
                            <input type="hidden" name="recipeId" th:value="${recipe.id}"/>
                            <input type="hidden" name="searchType" th:value="${searchType}"/>
                            <input type="hidden" name="productName" th:value="${productName}"/>
                            <input type="hidden" name="recipeName" th:value="${recipeName}"/>
                            <input type="hidden" name="page" th:value="${page.number}"/>
                            <input type="hidden" name="size" th:value="${page.size}"/>
                            <button type="submit" value="Добави в любими" id="addToFavoriteBtn"><i
                                    class="fa-regular fa-heart"></i></button>
                        </form>
                    </div>

                    <div th:if="${favoritesMap[recipe.id] == true}">
                        <form id="removeFromFavoriteForm" th:action="@{/removeFromFavorite}" method="post">
                            <input type="hidden" name="recipeId" th:value="${recipe.id}"/>
                            <input type="hidden" name="searchType" th:value="${searchType}"/>
                            <input type="hidden" name="productName" th:value="${productName}"/>
                            <input type="hidden" name="recipeName" th:value="${recipeName}"/>
                            <input type="hidden" name="page" th:value="${page.number}"/>
                            <input type="hidden" name="size" th:value="${page.size}"/>
                            <button type="submit" value="Махни от любими" id="removeFromFavoriteBtn"><i
                                    class="fa-solid fa-heart"></i></button>
                        </form>
                    </div>

                </div>
                <!--                <div>-->
                <!--                    <button value="Харесвам!"><i class="fa-regular fa-thumbs-up"></i></button>-->
                <!--                    <button value="Харесано!"><i class="fa-solid fa-thumbs-up"></i></button>-->
                <!--                </div>-->
            </div>
            <h5>Необходими продукти:</h5>
            <div th:each="ingredient : ${recipe.getIngredients()}">
                <p th:text="${ingredient.toString()}" style="margin-top: -10px"></p>
            </div>
            <button class="btn btn-link" onclick="toggleContent(this)">Цъкни за рецепта</button>
            <p th:text="${recipe.preparationDescription}" class="full-content d-none">Full Preparation Description</p>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("JavaScript is loaded");

        function attachEventListeners() {
            const forms = document.querySelectorAll("form[id^='addToFavoriteForm'], form[id^='removeFromFavoriteForm']");

            forms.forEach(function(form) {
                // Remove existing event listener in order to avoid multiple event triggers
                form.removeEventListener('submit', handleFormSubmit);
                // Attach new event listener
                form.addEventListener('submit', handleFormSubmit);
            });
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            let formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (!response.ok) {
                    throw new Error('An error occurred, please try again later.');
                }
                return response.json();
            }).then(data => {
                if (data.success) {
                    updateFavoritesMap(data.favoritesMap);
                } else {
                    console.error('Error: Response indicates failure', data);
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('An error occurred, please try again later.');
            });
        }

        function updateFavoritesMap(favoritesMap) {
            document.querySelectorAll('[data-recipe-id]').forEach(function(element) {
                const recipeId = element.getAttribute('data-recipe-id');
                const isFavorite = favoritesMap[recipeId];
                const heartIcon = element.querySelector('i');

                if (isFavorite) {
                    heartIcon.classList.remove('fa-regular');
                    heartIcon.classList.add('fa-solid');
                    const addToFavoriteForm = element.querySelector('form[id^="addToFavoriteForm"]');
                    if (addToFavoriteForm) {
                        addToFavoriteForm.outerHTML = `
                        <form id="removeFromFavoriteForm" action="/removeFromFavorite" method="post">
                            <input type="hidden" name="recipeId" value="${recipeId}"/>
                            <button type="submit" value="Махни от любими" id="removeFromFavoriteBtn"><i class="fa-solid fa-heart"></i></button>
                        </form>
                    `;
                    }
                } else {
                    heartIcon.classList.remove('fa-solid');
                    heartIcon.classList.add('fa-regular');
                    const removeFromFavoriteForm = element.querySelector('form[id^="removeFromFavoriteForm"]');
                    if (removeFromFavoriteForm) {
                        removeFromFavoriteForm.outerHTML = `
                        <form id="addToFavoriteForm" action="/addToFavorite" method="post">
                            <input type="hidden" name="recipeId" value="${recipeId}"/>
                            <button type="submit" value="Добави в любими" id="addToFavoriteBtn"><i class="fa-regular fa-heart"></i></button>
                        </form>
                    `;
                    }
                }
            });

            // Re-attach event listeners after updating the DOM
            attachEventListeners();
        }

        // Initial attachment of event listeners
        attachEventListeners();
    });

    function toggleContent(button) {
        const fullContent = button.nextElementSibling;
        if (fullContent.classList.contains('d-none')) {
            fullContent.classList.remove('d-none');
            button.style.display = 'none';
        } else {
            fullContent.classList.add('d-none');
            button.textContent = 'Show more';
        }
    }

    document.getElementById('productSearchBtn').addEventListener('click', function () {
        document.getElementById('productSearch').classList.remove('d-none');
        document.getElementById('recipeSearch').classList.add('d-none');
        document.getElementById('searchType').value = 'product';
    });

    document.getElementById('recipeSearchBtn').addEventListener('click', function () {
        document.getElementById('recipeSearch').classList.remove('d-none');
        document.getElementById('productSearch').classList.add('d-none');
        document.getElementById('searchType').value = 'recipe';
    });
    document.getElementById('productSearchBtn').addEventListener('click', function () {
        this.classList.add('btn-selected');
        document.getElementById('recipeSearchBtn').classList.remove('btn-selected');
    });

    document.getElementById('recipeSearchBtn').addEventListener('click', function () {
        this.classList.add('btn-selected');
        document.getElementById('productSearchBtn').classList.remove('btn-selected');
    });
</script>
</body>

<style>
       .d-none {
        opacity: 0;
        pointer-events: none;
    }

    .btn {
        color: black;
    }

    #results {
        width: 85%;
    }

    #singleRecipe {
        border: 1px solid #ffc107;
        margin: 10px;
        border-radius: 10px;
        width: 28.3%;
    }
    .page-item {
        margin: 10px;
        font-size: large;
    }

    #recipeContainer {
        max-width: 100%;
    }
</style>
</html>